# Production Deployment Checklist

## ‚úÖ Pre-Deployment Security Audit Completed

The following critical security issues have been fixed in `settings.py`:

### Security Fixes Applied

1. ‚úÖ **SECRET_KEY Protection**
   - Now fails loudly if not set in production
   - No empty fallback that could break the app

2. ‚úÖ **DEBUG Mode**
   - Changed default from `True` to `False`
   - Safe for production by default

3. ‚úÖ **ALLOWED_HOSTS**
   - Now validates that hosts are configured
   - Includes localhost for development
   - Fails with clear error if not set in production

4. ‚úÖ **CORS Security**
   - `CORS_ALLOW_ALL_ORIGINS` only enabled in DEBUG mode
   - Production requires explicit whitelist via environment variable
   - No hardcoded development IPs in production

5. ‚úÖ **HTTPS/SSL Security Headers**
   - `SECURE_SSL_REDIRECT`: Forces HTTPS
   - `HSTS`: HTTP Strict Transport Security (1 year)
   - `SECURE_PROXY_SSL_HEADER`: For reverse proxies
   - Secure cookies for sessions and CSRF

6. ‚úÖ **Email Configuration**
   - Console backend for development
   - SMTP for production
   - Environment variable driven

7. ‚úÖ **Redis Configuration**
   - Localhost for development
   - Environment variable for production

8. ‚úÖ **Security Headers**
   - `X-Frame-Options: DENY`
   - `X-Content-Type-Options: nosniff`
   - XSS filtering enabled

9. ‚úÖ **Logging System**
   - Structured logging with formatters
   - Different levels for dev/production
   - Console output for containerized deployments

## üöÄ Digital Ocean Deployment Steps

### 1. Environment Variables Setup

Create these environment variables in Digital Ocean App Platform:

```env
# Required - Critical
DJANGO_SECRET_KEY=<generate-a-long-random-string>
DJANGO_DEBUG=False
DJANGO_ALLOWED_HOSTS=your-app.ondigitalocean.app,yourdomain.com

# Required - Database (from Digital Ocean managed DB)
POSTGRES_DB=restaurant_db
POSTGRES_USER=doadmin
POSTGRES_PASSWORD=<from-digital-ocean>
POSTGRES_HOST=<from-digital-ocean>
POSTGRES_PORT=25060

# Required - CORS
CORS_ALLOWED_ORIGINS=https://your-frontend.ondigitalocean.app,https://yourdomain.com

# Optional - Email (if using email features)
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_USE_TLS=True
EMAIL_HOST_USER=your-email@gmail.com
EMAIL_HOST_PASSWORD=your-app-password
DEFAULT_FROM_EMAIL=The Restaurant <noreply@therestaurant.com>

# Optional - Frontend URL
FRONTEND_URL=https://your-frontend.ondigitalocean.app

# Optional - Redis (if using WebSockets/Channels)
REDIS_URL=redis://<redis-host>:6379

# Optional - Logging
DJANGO_LOG_LEVEL=INFO
```

### 2. Generate SECRET_KEY

Run this in your local terminal to generate a secure secret key:

```bash
python -c "from django.core.management.utils import get_random_secret_key; print(get_random_secret_key())"
```

### 3. Database Setup

1. Create a PostgreSQL database in Digital Ocean
2. Copy connection details to environment variables
3. Run migrations after first deployment:
   ```bash
   python manage.py migrate
   python manage.py collectstatic --noinput
   python manage.py createsuperuser
   ```

### 4. Deploy Backend

**Option A: App Platform (Recommended)**
- Connect GitHub repository
- Select `backend` folder as source
- Set build command: `pip install -r requirements.txt`
- Set run command: `gunicorn therestaurant.wsgi --log-file -`
- Add all environment variables

**Option B: Droplet**
- Set up Ubuntu server
- Install Nginx + PostgreSQL
- Configure Gunicorn as systemd service
- Set up SSL with Let's Encrypt

### 5. Deploy Frontend

- Deploy `webapp/build` folder as Static Site
- Set environment variable: `REACT_APP_API_URL=https://your-backend.ondigitalocean.app`

### 6. Post-Deployment Verification

Check these after deployment:

- [ ] Homepage loads without errors
- [ ] API documentation accessible at `/api/schema/swagger-ui/`
- [ ] Admin panel accessible at `/admin/`
- [ ] User registration/login works
- [ ] Media file uploads work
- [ ] HTTPS is enforced (no HTTP access)
- [ ] CORS allows frontend to access API
- [ ] Email sending works (if configured)
- [ ] No debug information visible in errors
- [ ] Database connections working
- [ ] Static files loading correctly

### 7. Monitoring & Maintenance

- Enable Digital Ocean monitoring
- Set up error tracking (e.g., Sentry)
- Configure automated backups for database
- Set up log aggregation
- Monitor application metrics

## üîí Security Best Practices

1. **Never commit `.env` file** - Already in `.gitignore`
2. **Rotate SECRET_KEY** if it's ever exposed
3. **Use strong database passwords** - Generated by Digital Ocean
4. **Keep dependencies updated** - Run `pip list --outdated` regularly
5. **Enable 2FA** on Digital Ocean account
6. **Regular security audits** - Use tools like `safety check`
7. **Backup database regularly** - Enable automated backups

## üìù Environment-Specific Settings

### Development (.env)
```env
DJANGO_DEBUG=True
DJANGO_SECRET_KEY=dev-only-secret-key
# Database: Uses SQLite by default
# CORS: Allows all origins
```

### Production (Digital Ocean)
```env
DJANGO_DEBUG=False
DJANGO_SECRET_KEY=<strong-secret-key>
DJANGO_ALLOWED_HOSTS=<your-domains>
CORS_ALLOWED_ORIGINS=<your-frontend-domains>
# PostgreSQL required
# Email SMTP required
```

## üÜò Troubleshooting

### "DisallowedHost" Error
- Check `DJANGO_ALLOWED_HOSTS` includes your domain
- Verify domain format (no http://, no trailing slash)

### "CORS Error" in Frontend
- Check `CORS_ALLOWED_ORIGINS` includes frontend URL
- Ensure using HTTPS in production URLs
- Check browser console for exact origin being blocked

### Static Files Not Loading
- Run `python manage.py collectstatic`
- Check `STATIC_ROOT` and `STATIC_URL` settings
- Verify WhiteNoise middleware is enabled

### Database Connection Failed
- Verify all POSTGRES_* environment variables are set
- Check database host is accessible
- Ensure SSL mode is supported by your provider

### 500 Internal Server Error
- Check application logs in Digital Ocean console
- Verify `DEBUG=False` to avoid exposing error details
- Check `DJANGO_LOG_LEVEL` is set to see detailed logs

## üìö Additional Resources

- [Digital Ocean App Platform Docs](https://docs.digitalocean.com/products/app-platform/)
- [Django Deployment Checklist](https://docs.djangoproject.com/en/5.2/howto/deployment/checklist/)
- [Django Security Best Practices](https://docs.djangoproject.com/en/5.2/topics/security/)
